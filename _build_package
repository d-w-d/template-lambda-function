#!/bin/bash
set -e

# Load environment variables
source .env

# Check for required environment variables
if [ -z "$DOCKER_IMAGE_NAME" ]; then
  echo "ERROR: DOCKER_IMAGE_NAME is not set in your .env file."
  echo "Please add DOCKER_IMAGE_NAME=lambda-builder to your .env file and try again."
  exit 1
fi

if [ -z "$DOCKER_IMAGE_TAG" ]; then
  echo "ERROR: DOCKER_IMAGE_TAG is not set in your .env file."
  echo "Please add DOCKER_IMAGE_TAG=latest to your .env file and try again."
  exit 1
fi

# Check if the Docker image exists
if ! docker image inspect ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} >/dev/null 2>&1; then
  echo "Docker image '${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}' not found. Please run ./_build_docker first."
  exit 1
fi

# Run the build process inside the Docker container
echo "Building Lambda package in Docker container..."
docker run --rm --memory=4g -v $(pwd):/app ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} /app/docker/build.sh

echo "Lambda package created successfully."
