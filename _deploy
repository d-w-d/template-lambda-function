#!/bin/bash
set -e

# Load environment variables
source .env

# Set AWS credentials explicitly with correct case for AWS CLI
export AWS_ACCESS_KEY_ID=${aws_access_key_id}
export AWS_SECRET_ACCESS_KEY=${aws_secret_access_key}
export AWS_DEFAULT_REGION=${aws_region}

# Build and package the Lambda function
echo "Building and packaging Lambda function..."
npm run build:package

# Initialize and apply OpenTofu configuration
echo "Deploying infrastructure with OpenTofu..."
cd infrastructure

# Create tfstate directory if it doesn't exist
mkdir -p tfstate

# Initialize OpenTofu with the backend configuration
tofu init

# Check for stale locks and force-remove if present
[ -f "tfstate/terraform.tfstate.lock.info" ] && rm -f tfstate/terraform.tfstate.lock.info || true

# Apply the configuration with variables from .env - using lowercase var names for AWS credentials
tofu apply -auto-approve \
  -var="aws_region=${aws_region}" \
  -var="aws_access_key_id=${aws_access_key_id}" \
  -var="aws_secret_access_key=${aws_secret_access_key}" \
  -var="lambda_function_name=${LAMBDA_FUNCTION_NAME}" \
  -var="s3_bucket_name=${S3_BUCKET_NAME}" \
  -var="s3_file_prefix=${S3_FILE_PREFIX}" \
  -var="api_gateway_stage=${API_GATEWAY_STAGE}" \
  -var="cloudfront_price_class=${CLOUDFRONT_PRICE_CLASS}" \
  -var="cloudfront_description=${CLOUDFRONT_DESCRIPTION}"

# Get the API Gateway URL from the outputs
API_URL=$(tofu output -raw api_gateway_url)

echo "Deployment completed successfully!"
echo "API Gateway URL: ${API_URL}"
echo "To test the endpoint, run: ./_ping-endpoint"
