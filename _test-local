#!/bin/bash
set -e

# Load environment variables
source .env

# Check for required environment variables
if [ -z "$DOCKER_IMAGE_NAME" ]; then
  echo "ERROR: DOCKER_IMAGE_NAME is not set in your .env file."
  echo "Please add DOCKER_IMAGE_NAME=lambda-builder to your .env file and try again."
  exit 1
fi

if [ -z "$DOCKER_IMAGE_TAG" ]; then
  echo "ERROR: DOCKER_IMAGE_TAG is not set in your .env file."
  echo "Please add DOCKER_IMAGE_TAG=latest to your .env file and try again."
  exit 1
fi

# Check for AWS environment variables
if [ -z "$aws_access_key_id" ] || [ -z "$aws_secret_access_key" ] || [ -z "$aws_region" ]; then
  echo "ERROR: AWS credentials not properly set in your .env file."
  echo "Please ensure aws_access_key_id, aws_secret_access_key, and aws_region are set."
  exit 1
fi

# Check if Docker is running
if ! docker info >/dev/null 2>&1; then
  echo "Docker is not running. Please start Docker and try again."
  exit 1
fi

# Build the Docker image and run the build process
echo "Building Lambda function using Docker..."
./_build

# Run Jest tests
echo "Running tests..."
npm test

# Set up local environment for Lambda invocation
echo "Setting up local environment..."
export AWS_REGION=${aws_region}
export AWS_ACCESS_KEY_ID=${aws_access_key_id}
export AWS_SECRET_ACCESS_KEY=${aws_secret_access_key}
export S3_BUCKET_NAME=${S3_BUCKET_NAME}
export S3_FILE_PREFIX=${S3_FILE_PREFIX}
export CLOUDFRONT_DOMAIN="dummy-cloudfront-domain.cloudfront.net"

# Install lambda-local if not already installed
if ! npm list -g lambda-local >/dev/null 2>&1; then
  echo "Installing lambda-local..."
  npm install -g lambda-local
fi

# Run the Lambda function with a mock event
echo "Invoking Lambda function locally..."
lambda-local -l dist/index.js -e test/mock/event.json -t 30000

echo "Local test completed successfully!"
