#!/bin/bash
set -e

# Load environment variables
source .env

# Check for required environment variables
if [ -z "$DOCKER_IMAGE_NAME" ]; then
  echo "ERROR: DOCKER_IMAGE_NAME is not set in your .env file."
  echo "Please add DOCKER_IMAGE_NAME=lambda-builder to your .env file and try again."
  exit 1
fi

if [ -z "$DOCKER_IMAGE_TAG" ]; then
  echo "ERROR: DOCKER_IMAGE_TAG is not set in your .env file."
  echo "Please add DOCKER_IMAGE_TAG=latest to your .env file and try again."
  exit 1
fi

# Build the Docker image for Lambda packaging with proper tags
echo "Building Docker image '${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}'..."
docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} -f docker/Dockerfile .

# Clean up dangling images
echo "Cleaning up dangling Docker images..."
docker image prune -f

echo "Docker image '${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}' created successfully."
