#!/bin/bash
set -e

# Load environment variables
source .env

# Print warning and confirmation
echo "WARNING: This will destroy all AWS infrastructure created by this project."
echo "Resources that will be destroyed:"
echo "- Lambda function: ${LAMBDA_FUNCTION_NAME}"
echo "- S3 bucket: ${S3_BUCKET_NAME} (will be emptied first)"
echo "- API Gateway"
echo "- CloudFront distribution"
echo "- IAM roles and policies"
echo ""
echo "This action cannot be undone."
echo ""
read -p "Are you sure you want to proceed? (y/N) " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Destruction cancelled."
  exit 1
fi

# AWS CLI will automatically use AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, and AWS_REGION
# from the environment variables loaded from .env

# Empty the S3 bucket first
echo "Emptying S3 bucket: ${S3_BUCKET_NAME}..."
aws s3 rm s3://${S3_BUCKET_NAME} --recursive || {
  echo "Warning: Could not empty S3 bucket. Continuing with destruction anyway..."
}

# Initialize and destroy OpenTofu configuration
echo "Destroying infrastructure with OpenTofu..."
cd infrastructure

# Remove any leftover force_delete_s3.tf file if it exists
if [ -f "force_delete_s3.tf" ]; then
  echo "Removing leftover force_delete_s3.tf file..."
  rm -f force_delete_s3.tf
fi

# Initialize OpenTofu if needed
if [ ! -d ".terraform" ]; then
  echo "Initializing OpenTofu..."
  tofu init
fi

# Destroy the configuration with variables from .env
tofu destroy \
  -var="aws_region=${AWS_REGION}" \
  -var="aws_access_key_id=${AWS_ACCESS_KEY_ID}" \
  -var="aws_secret_access_key=${AWS_SECRET_ACCESS_KEY}" \
  -var="lambda_function_name=${LAMBDA_FUNCTION_NAME}" \
  -var="s3_bucket_name=${S3_BUCKET_NAME}" \
  -var="s3_file_prefix=${S3_FILE_PREFIX}" \
  -var="api_gateway_stage=${API_GATEWAY_STAGE}" \
  -var="cloudfront_price_class=${CLOUDFRONT_PRICE_CLASS}"

echo "Infrastructure destruction completed."
echo "Note: CloudWatch log groups may still exist as they are not managed by OpenTofu."
echo "You may want to manually delete the log group: /aws/lambda/${LAMBDA_FUNCTION_NAME}"
